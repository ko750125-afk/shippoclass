<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIPPO SLOTS - Japanese Sentence Maker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Orbitron:wght@500;700;900&display=swap');

        :root {
            --color-bg: #0a0a0a;
            --color-gold: #FFD700;
            --color-gold-shine: #FFF8DC;
            --color-neon-red: #FF0033;
            --color-panel: rgba(20, 20, 20, 0.9);
            --font-jp: 'M PLUS Rounded 1c', sans-serif;
            --font-digit: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
            color: white;
            font-family: var(--font-jp);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            width: 100%;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .pachinko-frame {
            border: 4px solid var(--color-gold);
            box-shadow: 0 0 10px var(--color-gold);
            border-radius: 20px;
            background: var(--color-panel);
            position: relative;
        }

        button {
            cursor: pointer;
            font-family: var(--font-jp);
        }

        .btn-nav {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 1rem 0;
            margin: 0 auto;
        }

        .slot-machine {
            background: linear-gradient(180deg, #2a2a2a 0%, #000 100%);
            border: 8px solid var(--color-gold);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            position: relative;
        }

        .reels-container {
            display: flex;
            gap: 15px;
            background: #000;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #555;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .reel-window {
            flex: 1;
            height: 180px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .reel-tape {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: top 0.1s linear;
        }

        .reel-item {
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: black;
            border-bottom: 1px solid #eee;
        }

        .reel-item .kanji {
            font-size: 1.8rem;
            color: #d00;
            margin-bottom: 5px;
        }

        .reel-item .kana {
            font-size: 0.9rem;
            color: #666;
        }

        .controls-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        #start-lever {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff4444, #990000);
            border: 4px solid var(--color-gold-shine);
            color: white;
            font-weight: 900;
        }

        .btn-stop {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4444ff, #000099);
            border: 3px solid #aaf;
            color: white;
        }

        .btn-stop:disabled {
            opacity: 0.3;
        }

        .status-display {
            background: black;
            border: 2px solid var(--color-neon-red);
            padding: 10px;
            text-align: center;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .status-text {
            font-family: var(--font-digit);
            color: var(--color-neon-red);
        }

        @media (max-width: 600px) {
            .slot-machine {
                padding: 15px;
            }

            .reel-item .kanji {
                font-size: 1.2rem;
            }

            .reel-item .kana {
                display: none;
            }
        }

        /* Reach Effect Animation */
        @keyframes rainbow-border {
            0% {
                border-color: red;
                box-shadow: 0 0 10px red;
            }

            20% {
                border-color: orange;
                box-shadow: 0 0 20px orange;
            }

            40% {
                border-color: yellow;
                box-shadow: 0 0 40px yellow;
            }

            60% {
                border-color: green;
                box-shadow: 0 0 20px green;
            }

            80% {
                border-color: blue;
                box-shadow: 0 0 10px blue;
            }

            100% {
                border-color: purple;
                box-shadow: 0 0 10px purple;
            }
        }

        .reach-active {
            animation: rainbow-border 0.5s linear infinite !important;
            transform: scale(1.02);
            transition: transform 0.2s;
        }

        @keyframes rumble {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-2px, 2px);
            }

            50% {
                transform: translate(2px, -2px);
            }

            75% {
                transform: translate(-2px, -2px);
            }
        }

        @keyframes hinge-drop {
            0% {
                transform: rotate(0) translateY(0);
            }

            20% {
                transform: rotate(5deg) translateY(20px);
            }

            40% {
                transform: rotate(3deg) translateY(15px);
            }

            60% {
                transform: rotate(5deg) translateY(20px);
            }

            80% {
                transform: rotate(4deg) translateY(20px);
            }

            100% {
                transform: rotate(5deg) translateY(25px);
            }
        }

        .reach-active {
            /* animation: rainbow-border 0.5s linear infinite !important; */
            /* Replaced with hinge-drop as requested */
            animation: hinge-drop 0.8s ease-out forwards !important;
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.5);
            border-color: red !important;
        }

        .reach-background {
            background-color: rgba(255, 0, 0, 0.1) !important;
            animation: rumble 0.2s linear infinite;
            border: 2px solid red !important;
        }

        #result-meaning {
            background-color: rgba(200, 0, 0, 0.8);
            border: 2px solid #ff4b4b;
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-top: 15px;
            display: none;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; padding: 10px;">
            <a href="index.html" class="btn-nav">‚Üê LOBBY</a>
            <div id="coin-wallet"
                style="border: 2px solid var(--color-gold); padding: 5px 15px; border-radius: 20px; color: var(--color-gold);">
                üí∞ <span id="coin-count">0</span>
            </div>
        </div>

        <div class="slot-machine">
            <div class="status-display">
                <span id="status-text" class="status-text">CLICK START</span>
            </div>
            <div class="reels-container">
                <div class="reel-window">
                    <div class="reel-tape" id="reel-1"></div>
                </div>
                <div class="reel-window">
                    <div class="reel-tape" id="reel-2"></div>
                </div>
                <div class="reel-window">
                    <div class="reel-tape" id="reel-3"></div>
                </div>
            </div>
        </div>

        <div class="controls-area">
            <button class="btn-stop" id="stop-1" disabled>S1</button>
            <button class="btn-stop" id="stop-2" disabled>S2</button>
            <button class="btn-stop" id="stop-3" disabled>S3</button>
            <button id="start-lever">START</button>
        </div>
        <p id="result-meaning" style="text-align:center; color: #aaa; font-size: 1.2rem; margin-top:20px;"></p>
    </div>
    <script>
        // --- Debug Manager ---
        // --- Audio Control ---
        let jaVoice = null;
        let slotAudioCtx = null;

        // Polyfill
        if (!window.speechSynthesis && window.webkitSpeechSynthesis) {
            window.speechSynthesis = window.webkitSpeechSynthesis;
        }

        // GLOBAL VARIABLE TO PREVENT GC
        window.ttsUtterance = null;

        function loadVoices() {
            if (!window.speechSynthesis) return;
            const voices = window.speechSynthesis.getVoices();
            if (!voices.length) return;

            const lowerJa = ['ja-jp', 'ja_jp', 'ja'];
            jaVoice = voices.find(v => lowerJa.includes(v.lang.toLowerCase())) ||
                voices.find(v => v.lang.toLowerCase().startsWith('ja')) || null;
        }
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        // Silent TTS Warm-up
        function warmUpTTS() {
            if (!window.speechSynthesis) return;
            const u = new SpeechSynthesisUtterance('');
            u.volume = 0;
            window.speechSynthesis.speak(u);
        }

        function resumeAudio() {
            if (!slotAudioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) slotAudioCtx = new AudioContext();
            }
            if (slotAudioCtx && slotAudioCtx.state === 'suspended') slotAudioCtx.resume();

            // Warm up TTS as well
            warmUpTTS();
        }

        const Utils = {
            speak: (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                resumeAudio();
                if (!jaVoice) loadVoices();
                setTimeout(() => {
                    const u = new SpeechSynthesisUtterance(text);
                    window.ttsUtterance = u;
                    if (jaVoice) u.voice = jaVoice;
                    u.lang = 'ja-JP';
                    u.rate = 1.0;
                    window.speechSynthesis.speak(window.ttsUtterance);
                }, 50);
            },
            playSound: (type) => {
                resumeAudio();
                if (!slotAudioCtx) return;
                const ctx = slotAudioCtx; const now = ctx.currentTime;
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);

                if (type === 'win') {
                    // Victory fanfare
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now); // C5
                    osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
                    osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
                    osc.frequency.setValueAtTime(1046.50, now + 0.3); // C6

                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
                    gain.gain.setValueAtTime(0.3, now + 0.3);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);

                    osc.start(now); osc.stop(now + 0.8);
                } else if (type === 'spin') {
                    // Mechanical spin sound (low rumbles)
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'stop') {
                    // Heavy clunk
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                } else if (type === 'reach') {
                    // Suspenseful ping (High pitch alert)
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                }
            }
        };

        const reelElements = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];
        const statusText = document.getElementById('status-text');
        const coinCountDisplay = document.getElementById('coin-count');
        const resultMeaning = document.getElementById('result-meaning');

        let userCoins = parseInt(localStorage.getItem('shippo_coins')) || 100;
        let slotData = null;
        let reels = [[], [], []];
        let spinIntervals = [null, null, null];
        let stopping = [false, false, false];
        let stopCount = 0;

        async function init() {
            // Sound bar logic removed
            const resp = await fetch('data/slots.json');
            slotData = await resp.json();

            const fails = (slotData.failEvents || []).map(f => ({ kanji: f.emoji, text: "X", meaning: "", type: 'fail' }));

            reels[0] = [...slotData.subjects, ...fails, ...slotData.subjects];
            const objKeys = Object.keys(slotData.objects).map(k => ({ text: k, kanji: k, meaning: slotData.objects[k].meaning }));
            reels[1] = [...objKeys, ...fails, ...objKeys];
            reels[2] = [...slotData.verbs, ...fails, ...slotData.verbs];

            reels.forEach((r, i) => {
                reelElements[i].innerHTML = r.map(item => `<div class="reel-item"><div class="kanji">${item.kanji}</div><div class="kana">${item.text}</div></div>`).join('');
            });

            coinCountDisplay.textContent = userCoins;

            document.getElementById('start-lever').onclick = startSpin;
            [0, 1, 2].forEach(i => document.getElementById(`stop-${i + 1}`).onclick = () => stopReel(i));
        }


        function startSpin() {
            if (spinIntervals.some(i => i)) return;
            if (userCoins < 10) { alert("Coins needed!"); return; }
            userCoins -= 10; coinCountDisplay.textContent = userCoins; localStorage.setItem('shippo_coins', userCoins);

            resumeAudio();
            stopCount = 0; stopping = [false, false, false];
            resultMeaning.textContent = "";
            resultMeaning.style.display = 'none';

            // Reset Reach Effects
            document.querySelector('.slot-machine').classList.remove('reach-active');
            document.querySelector('.container').classList.remove('reach-background');
            statusText.style.color = "var(--color-neon-red)";

            reels.forEach((_, i) => {
                let pos = 0;
                // Init all reels FAST (20ms)
                spinIntervals[i] = setInterval(() => {
                    pos -= 20; if (pos <= -180 * reels[i].length / 3) pos = 0;
                    reelElements[i].style.top = pos + "px";
                }, 20);
                document.getElementById(`stop-${i + 1}`).disabled = false;
            });
            Utils.playSound('spin');
        }

        function stopReel(i) {
            if (stopping[i] || !spinIntervals[i]) return;
            clearInterval(spinIntervals[i]);
            spinIntervals[i] = null;
            stopping[i] = true;
            stopCount++;

            const finalPos = Math.round(parseFloat(reelElements[i].style.top) / 180) * 180;
            reelElements[i].style.top = finalPos + "px";
            Utils.playSound('stop');
            document.getElementById(`stop-${i + 1}`).disabled = true;

            // Check Reach (after 2nd reel stops)
            if (stopCount === 2) {
                // Determine which reel is still spinning (should be index 2 if user stopped 0 and 1)
                const lastReelIndex = stopping.findIndex(s => !s);

                if (lastReelIndex !== -1) {
                    // Slow down the last reel!
                    clearInterval(spinIntervals[lastReelIndex]);
                    let pos = parseFloat(reelElements[lastReelIndex].style.top);
                    spinIntervals[lastReelIndex] = setInterval(() => {
                        pos -= 20; if (pos <= -180 * reels[lastReelIndex].length / 3) pos = 0;
                        reelElements[lastReelIndex].style.top = pos + "px";
                    }, 80); // Slow speed
                }

                // Check if Natural (Valid Subject + Valid Object)
                const getSymbol = (i) => {
                    const r = reels[i];
                    const top = parseFloat(reelElements[i].style.top);
                    const idx = (Math.abs(Math.round(top / 180)) % r.length);
                    return r[idx];
                };

                const s1 = getSymbol(0);
                const s2 = getSymbol(1);

                if (s1 && s2 && s1.type !== 'fail' && s2.type !== 'fail') {
                    Utils.playSound('reach');
                    Utils.speak('„É™„Éº„ÉÅÔºÅ'); // RIICHI!
                    statusText.textContent = "REACH!!";
                    statusText.style.color = "var(--color-neon-red)";

                    // ADD RICH EFFECT
                    document.querySelector('.slot-machine').classList.add('reach-active');
                    document.querySelector('.container').classList.add('reach-background');
                }
            }

            if (stopCount === 3) finishSpin();
        }

        function finishSpin() {
            const results = reels.map((r, i) => {
                const idx = Math.abs(Math.round(parseFloat(reelElements[i].style.top) / 180));
                return r[idx];
            });
            const sentence = results.map(r => r.kanji).join(' ');
            const meaning = results.map(r => r.meaning).join(' ');

            // Check Win Logic
            // Reel 2 (Object) dictates allowed verbs in Reel 3
            // results[1].text is the key for objects e.g. "„É©„Éº„É°„É≥„Çí"
            // results[2].kanji is the verb kanji e.g. "È£ü„Åπ„Åæ„Åó„Åü"
            const objKey = results[1].text;
            const verbKanji = results[2].kanji;
            const validVerbs = slotData.objects[objKey] ? slotData.objects[objKey].verbs : [];

            const isWin = validVerbs.includes(verbKanji);

            resultMeaning.textContent = meaning + (isWin ? " (Great!)" : " (?)");
            resultMeaning.style.display = 'block';

            // Speak regardless, but maybe tone differs? For now just speak.
            Utils.speak(sentence);

            // Cleanup Reach Effects
            document.querySelector('.slot-machine').classList.remove('reach-active');
            document.querySelector('.container').classList.remove('reach-background');

            if (isWin) {
                userCoins += 50;
                coinCountDisplay.textContent = userCoins;
                localStorage.setItem('shippo_coins', userCoins);
                Utils.playSound('win');
                statusText.textContent = "WIN! +50";
                statusText.style.color = "#4bff4b";
            } else {
                statusText.textContent = "TRY AGAIN";
                statusText.style.color = "#ff4b4b";
            }
        }

        init();
    </script>
</body>

</html>