<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÌûàÎùºÍ∞ÄÎÇò ÎßàÏä§ÌÑ∞ - Ïã≠ÎΩÄÍµêÏã§</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --color-red: #ff4b4b;
            --color-gold: #FFD700;
            --color-bg: #1a1a1a;
            --color-card: #2d2d2d;
            --font-main: 'Noto Sans KR', sans-serif;
            --font-jp: 'Noto Sans JP', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            color: #fff;
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
        }

        .btn-nav {
            display: inline-block;
            padding: 10px 20px;
            background: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: 0.3s;
            border: 2px solid #555;
        }

        .btn-nav:hover {
            background: #444;
            border-color: var(--color-gold);
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .hiragana-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .hiragana-grid.small-grid {
            grid-template-columns: repeat(5, 1fr);
            max-width: 400px;
            margin: 20px auto;
            gap: 5px;
        }

        .char-btn {
            background: var(--color-card);
            border-radius: 12px;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .char-btn:hover {
            transform: translateY(-3px);
            border-color: var(--color-gold);
            background: #3d3d3d;
        }

        .char-btn.active {
            background: var(--color-gold) !important;
            color: #000 !important;
            transform: scale(0.95);
        }

        .char-btn.empty {
            visibility: hidden;
            pointer-events: none;
        }

        .char-btn span:first-child {
            font-family: var(--font-jp);
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .char-btn .romaji {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        .column-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
        }

        .col-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .col-btn.active {
            background: var(--color-gold);
            color: #000;
            border-color: #fff;
        }

        #feedback-display {
            text-align: center;
            font-size: 1.5rem;
            min-height: 3rem;
            margin: 10px 0;
            font-weight: bold;
        }

        #feedback-display.correct {
            color: #4bff4b;
        }

        #feedback-display.wrong {
            color: var(--color-red);
        }

        .final-carousel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            position: relative;
            perspective: 1000px;
        }

        .final-card {
            width: 200px;
            height: 280px;
            background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
            border: 4px solid var(--color-gold);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: 0.5s;
        }

        .final-card.active-slot {
            transform: scale(1.1) translateZ(50px);
            z-index: 10;
            box-shadow: 0 0 40px var(--color-gold);
        }

        .final-card .char {
            font-family: var(--font-jp);
            font-size: 6rem;
            font-weight: bold;
        }

        @keyframes pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @media (max-width: 480px) {
            .char-btn span:first-child {
                font-size: 1.4rem;
            }

            .col-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header style="text-align: center; margin-bottom: 30px;">
            <a href="index.html" class="btn-nav" style="margin-bottom: 15px;">‚Üê Î°úÎπÑÎ°ú</a>
            <h1 style="color: var(--color-gold); margin: 5px 0;">ÌûàÎùºÍ∞ÄÎÇò ÎßàÏä§ÌÑ∞</h1>
            <p id="instruction-text" style="opacity: 0.8; font-size: 0.9rem;">Í∏ÄÏûêÎ•º ÎàåÎü¨ÏÑú ÏÜåÎ¶¨Î•º Îì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
        </header>

        <div class="mode-selector">
            <button class="mode-btn" id="btn-practice">Ïó∞Ïäµ Î™®Îìú</button>
            <button class="mode-btn" id="btn-challenge">ÎèÑÏ†Ñ Î™®Îìú</button>
            <button class="mode-btn" id="btn-final">ÌååÏù¥ÎÑê ÌÖåÏä§Ìä∏</button>
        </div>

        <div id="column-selector" class="column-selector"></div>
        <div id="feedback-display"></div>
        <div id="grid" class="hiragana-grid">
            <!-- Grid items will be generated here -->
        </div>
    </div>
    <script>
        // --- Audio Control ---
        let jaVoice = null;
        let hiraganaAudioCtx = null;

        // 1. Browser Compatibility Check (Polyfill)
        if (!window.speechSynthesis && window.webkitSpeechSynthesis) {
            window.speechSynthesis = window.webkitSpeechSynthesis;
        }

        function loadVoices() {
            if (!window.speechSynthesis) return;
            const voices = window.speechSynthesis.getVoices();
            if (!voices.length) return;
            jaVoice = voices.find(voice => voice.lang === 'ja-JP' || voice.lang === 'ja_JP');
            if (jaVoice) console.log(`Selected Voice: ${jaVoice.name}`);
            else {
                // Silent fallback
            }
        }

        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function warmUpTTS() {
            if (!window.speechSynthesis) return;
            const u = new SpeechSynthesisUtterance('');
            u.volume = 0;
            window.speechSynthesis.speak(u);
        }

        function resumeAudio() {
            if (!hiraganaAudioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) hiraganaAudioCtx = new AudioContext();
            }
            if (hiraganaAudioCtx && hiraganaAudioCtx.state === 'suspended') hiraganaAudioCtx.resume();

            warmUpTTS();
        }

        const Utils = {
            speak: (text) => {
                if (!window.speechSynthesis) return;

                // Galaxy Fix: Stop current speech immediately
                window.speechSynthesis.cancel();
                resumeAudio();

                // JIT Load Attempt
                if (!jaVoice) loadVoices();

                // Create Utterance
                const u = new SpeechSynthesisUtterance(text);

                // ASSIGN TO GLOBAL to prevent Android GC
                window.ttsUtterance = u;

                if (jaVoice) u.voice = jaVoice;
                // Fallback: If no voice matched, lang is the only hope.
                u.lang = 'ja-JP';
                u.rate = 1.0;
                u.pitch = 1.0;
                u.volume = 1.0;

                // Small delay for Android Chrome stabilization
                setTimeout(() => {
                    window.speechSynthesis.speak(window.ttsUtterance);
                }, 50);
            },
            playSound: (type) => {
                resumeAudio();
                if (!hiraganaAudioCtx) return;
                const ctx = hiraganaAudioCtx; const now = ctx.currentTime;
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                if (type === 'win') {
                    osc.frequency.setValueAtTime(659, now); gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.3, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                    osc.start(now); osc.stop(now + 0.6);
                } else if (type === 'error') {
                    // Buzz for error
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now); // Low pitch
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3); // Slide down
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'click') {
                    osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1);
                } else {
                    // Default / Confirm
                    osc.frequency.setValueAtTime(330, now); gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.5, now + 0.02); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                    osc.start(now); osc.stop(now + 0.4);
                }
            },
            randomItem: (array) => array[Math.floor(Math.random() * array.length)]
        };

        const hiraganaData = [
            ['„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä'],
            ['„Åã', '„Åç', '„Åè', '„Åë', '„Åì'],
            ['„Åï', '„Åó', '„Åô', '„Åõ', '„Åù'],
            ['„Åü', '„Å°', '„Å§', '„Å¶', '„Å®'],
            ['„Å™', '„Å´', '„Å¨', '„Å≠', '„ÅÆ'],
            ['„ÅØ', '„Å≤', '„Åµ', '„Å∏', '„Åª'],
            ['„Åæ', '„Åø', '„ÇÄ', '„ÇÅ', '„ÇÇ'],
            ['„ÇÑ', '', '„ÇÜ', '', '„Çà'],
            ['„Çâ', '„Çä', '„Çã', '„Çå', '„Çç'],
            ['„Çè', '', '„Çí', '', '„Çì'],
            ['„Åå', '„Åé', '„Åê', '„Åí', '„Åî'],
            ['„Åñ', '„Åò', '„Åö', '„Åú', '„Åû'],
            ['„Å†', '„Å¢', '„Å•', '„Åß', '„Å©'],
            ['„Å∞', '„Å≥', '„Å∂', '„Åπ', '„Åº'],
            ['„Å±', '„Å¥', '„Å∑', '„Å∫', '„ÅΩ']
        ];

        const romajiData = [
            ['a', 'i', 'u', 'e', 'o'],
            ['ka', 'ki', 'ku', 'ke', 'ko'],
            ['sa', 'shi', 'su', 'se', 'so'],
            ['ta', 'chi', 'tsu', 'te', 'to'],
            ['na', 'ni', 'nu', 'ne', 'no'],
            ['ha', 'hi', 'fu', 'he', 'ho'],
            ['ma', 'mi', 'mu', 'me', 'mo'],
            ['ya', '', 'yu', '', 'yo'],
            ['ra', 'ri', 'ru', 're', 'ro'],
            ['wa', '', 'wo', '', 'n'],
            ['ga', 'gi', 'gu', 'ge', 'go'],
            ['za', 'ji', 'zu', 'ze', 'zo'],
            ['da', 'ji', 'zu', 'de', 'do'],
            ['ba', 'bi', 'bu', 'be', 'bo'],
            ['pa', 'pi', 'pu', 'pe', 'po']
        ];

        const columns = ['„ÅÇ', '„Åã', '„Åï', '„Åü', '„Å™', '„ÅØ', '„Åæ', '„ÇÑ', '„Çâ', '„Çè', '„Åå', '„Åñ', '„Å†', '„Å∞', '„Å±'];

        let currentMode = 'practice';
        let currentChallengeChar = null;
        let isChallengeActive = false;
        let currentFilterIndex = null;
        let finalSet = [];
        let finalIdx = 0;
        let challengeRowSelected = false;

        const gridEl = document.getElementById('grid');
        const selectorEl = document.getElementById('column-selector');
        const feedbackEl = document.getElementById('feedback-display');

        function init() {
            // Sound bar logic removed
            renderSelector();
            renderGrid(null);
            document.getElementById('btn-practice').onclick = () => setMode('practice');
            document.getElementById('btn-challenge').onclick = () => startChallenge();
            document.getElementById('btn-final').onclick = () => setMode('final');
        }

        function setMode(mode) {
            currentMode = mode; isChallengeActive = false; challengeRowSelected = false; feedbackEl.textContent = '';

            // Reset filter if leaving practice or entering challenge to clear "lit up" rows
            if (mode === 'challenge' || mode === 'practice') {
                currentFilterIndex = null;
            }

            updateInstructions();
            if (mode === 'final') {
                finalSet = [];
                hiraganaData.forEach(row => row.forEach(c => { if (c) finalSet.push({ char: c, romaji: '' }); }));
                for (let i = finalSet.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [finalSet[i], finalSet[j]] = [finalSet[j], finalSet[i]];
                }
                finalIdx = 0;
            }
            updateModeButtons();
            renderGrid(currentFilterIndex);
        }

        function updateModeButtons() {
            const btns = { practice: 'btn-practice', challenge: 'btn-challenge', final: 'btn-final' };
            Object.keys(btns).forEach(m => {
                document.getElementById(btns[m]).style.background = currentMode === m ? "linear-gradient(180deg, #ff0000 0%, #8b0000 100%)" : "#333";
            });
        }

        function updateInstructions() {
            const inst = document.getElementById('instruction-text');
            if (currentMode === 'practice') inst.textContent = "Í∏ÄÏûêÎ•º ÎàåÎü¨ÏÑú ÏÜåÎ¶¨Î•º Îì§Ïñ¥Î≥¥ÏÑ∏Ïöî!";
            else if (currentMode === 'challenge') inst.textContent = "ÏÜåÎ¶¨Î•º Îì£Í≥† Í∏ÄÏûêÎ•º ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî!";
            else inst.textContent = "Ïπ¥ÎìúÎ•º ÎÑòÍ∏∞Î©∞ ÎßàÏßÄÎßâ Ï†êÍ≤ÄÏùÑ Ìï¥Î≥¥ÏÑ∏Ïöî!";
        }

        function renderSelector() {
            selectorEl.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = 'col-btn' + (currentFilterIndex === null ? ' active' : '');
            allBtn.textContent = 'Ï†ÑÏ≤¥';
            allBtn.onclick = () => { currentFilterIndex = null; challengeRowSelected = false; renderSelector(); renderGrid(null); };
            selectorEl.appendChild(allBtn);
            columns.forEach((col, idx) => {
                const btn = document.createElement('button');
                btn.className = 'col-btn' + (currentFilterIndex === idx ? ' active' : '');
                btn.textContent = col;
                btn.onclick = () => {
                    resumeAudio(); currentFilterIndex = idx;
                    if (currentMode === 'challenge') { challengeRowSelected = true; isChallengeActive = true; nextChallenge(); }
                    renderSelector(); renderGrid(idx);
                };
                selectorEl.appendChild(btn);
            });
        }

        function renderGrid(filterIdx) {
            gridEl.innerHTML = '';
            gridEl.className = (currentMode === 'final') ? 'hiragana-grid small-grid' : 'hiragana-grid';
            if (currentMode === 'final') { renderFinalMode(); return; }
            let data = [];
            if (filterIdx === null) {
                hiraganaData.forEach((row, rIdx) => {
                    data.push({ type: 'separator', label: columns[rIdx] + "Ìñâ" });
                    row.forEach((char, cIdx) => data.push({ char, romaji: romajiData[rIdx][cIdx], type: char ? '' : 'empty' }));
                });
            } else {
                hiraganaData[filterIdx].forEach((char, cIdx) => data.push({ char, romaji: romajiData[filterIdx][cIdx], type: char ? '' : 'empty' }));
            }
            if (currentMode === 'challenge') {
                data = data.filter(i => i.char);
                for (let i = data.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));[data[i], data[j]] = [data[j], data[i]];
                }
            }
            data.forEach(item => {
                const el = document.createElement('div');
                if (item.type === 'separator') {
                    el.style.gridColumn = '1 / -1'; el.innerHTML = `<span style="color:var(--color-gold); font-size:0.8rem;">${item.label}</span>`;
                } else {
                    el.className = 'char-btn' + (item.type === 'empty' ? ' empty' : ' animate-pop');
                    if (item.char) {
                        el.innerHTML = `<span>${item.char}</span><span class="romaji">${item.romaji}</span>`;
                        el.onclick = () => handleCharClick(item.char, el);
                    }
                }
                gridEl.appendChild(el);
            });
        }

        function renderFinalMode() {
            const item = finalSet[finalIdx]; if (!item) return;
            const container = document.createElement('div'); container.className = 'final-carousel';
            const prev = document.createElement('button'); prev.className = 'col-btn'; prev.textContent = '‚óÄ';
            prev.onclick = () => { if (finalIdx > 0) { finalIdx--; renderGrid(null); } };
            const card = document.createElement('div'); card.className = 'final-card active-slot animate-pop';
            card.innerHTML = `<div class="char">${item.char}</div>`; card.onclick = () => Utils.speak(item.char);
            const next = document.createElement('button'); next.className = 'col-btn'; next.textContent = '‚ñ∂';
            next.onclick = () => { if (finalIdx < finalSet.length - 1) { finalIdx++; renderGrid(null); } };
            container.appendChild(prev); container.appendChild(card); container.appendChild(next); gridEl.appendChild(container);
            const counter = document.createElement('div'); counter.style.textAlign = 'center';
            counter.textContent = `${finalIdx + 1} / ${finalSet.length}`; gridEl.appendChild(counter);
        }

        function handleCharClick(char, btn) {
            if (currentMode === 'practice' || currentMode === 'final') { Utils.speak(char); highlightBtn(btn); }
            else if (currentMode === 'challenge' && isChallengeActive) checkAnswer(char, btn);
        }

        function highlightBtn(btn) { btn.classList.add('active'); setTimeout(() => btn.classList.remove('active'), 300); }

        function startChallenge() { setMode('challenge'); isChallengeActive = true; feedbackEl.innerHTML = "ÌñâÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Î¨∏Ï†úÍ∞Ä ÏãúÏûëÎê©ÎãàÎã§!"; }

        function nextChallenge() {
            feedbackEl.textContent = "üîä Ïûò Îì£Í≥† ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî!"; feedbackEl.className = '';
            let pool = (currentFilterIndex === null) ? hiraganaData.flat().filter(c => c) : hiraganaData[currentFilterIndex].filter(c => c);
            currentChallengeChar = Utils.randomItem(pool); setTimeout(() => Utils.speak(currentChallengeChar), 500);
        }

        function checkAnswer(char, btn) {
            if (char === currentChallengeChar) {
                feedbackEl.textContent = "Ï†ïÎãµ! ‚ú®"; feedbackEl.className = "correct"; Utils.playSound('win');
                isChallengeActive = false; btn.classList.add('active');
                setTimeout(() => {
                    btn.classList.remove('active');
                    if (challengeRowSelected) { isChallengeActive = true; nextChallenge(); }
                    else startChallenge();
                }, 1500);
            } else {
                feedbackEl.textContent = "Îï°! Îã§Ïãú Îì§Ïñ¥Î≥¥ÏÑ∏Ïöî"; feedbackEl.className = "wrong";
                Utils.playSound('error'); Utils.speak(currentChallengeChar);
            }
        }
        window.onload = init;
    </script>
</body>

</html>